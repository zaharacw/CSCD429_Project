---
title: "data_exploration_initial"
output: html_document
---

Set the filename for your local file location

```{r}
fileName <-"/home/dev/CSCD429_Project/Data/DJIA_table.csv"
saveFile <-"/home/dev/CSCD429_Project/Data/DJIA_labels.csv"
imagesBase <- "/home/dev/CSCD429_Project/Images/"
```

Read in the stock data and transform the Date column into actual dates
```{r}
library(dplyr)
library(ggplot2)
stocks <- read.csv(file=fileName, header=TRUE, sep=",", stringsAsFactors = FALSE)
stocks <- mutate(stocks, Date=as.Date(Date))
```

Set the cut off date we want to use to separate our training and testing data
```{r}
cutOffDate <- as.Date("2015-01-01")
```

Allows separation of Test and Train data if desired
```{r}
#stock_train <- subset(stocks,Date<cutOffDate)
#stock_test <- subset(stocks, Date>=cutOffDate)
```

Export the training and testing data so we can share it
```{r}
#write.csv(stock_train, file="/home/dev/CSCD429_Project/DJIA_training.csv", row.names=FALSE, na="", sep=",")
#write.csv(stock_test, file="/home/dev/CSCD429_Project/DJIA_test.csv", row.names=FALSE, na="", sep=",")
```

Addings some new columns: the daily spread of the data (high - low), the movement within the day itself (open - close), the difference between the previous close and the current close, and the difference bewteen the previous close and the current opening
```{r}
dailyDiffs <- function(x) {
  x$Spread <- x$High - x$Low
  x$DailyMove <- x$Open - x$Close
  for (i in 1:(dim(x)[1] - 1)) {
    x$CloseDiff[i] <- x$Close[i+1] - x$Close[i]
    x$ONDiff[i] <- x$Close[i+1] - x$Open[i]
    x$SpreadPercent[i] <- x$Spread[i] / x$Close[i+1]
    x$DailyMovePercent[i] <- x$DailyMove[i] / x$Close[i+1]
    x$CloseDiffPercent[i] <- x$CloseDiffPercent[i] / x$Close[i+1]
    x$ONDiffPercent[i] <- x$ONDiff[i] / x$Close[i+1]
  }
  return(x)
}

stocks <- dailyDiffs(stocks)
```

Now lets add some additional data, standard deviation, mean, median
```{r}
generateStats <- function(x){
  stock_stats <- data.frame(colnames(x)[-1])
  colnames(stock_stats)[1] <- 'Name'
  rownames(stock_stats) <- stock_stats$Name
  
  std <- c();
  train_mean <- c()
  train_med <- c() 
  for (i in 1:(dim(stock_stats)[1])) {
    std[i] <- (var(x[[as.character(stock_stats$Name[i])]], na.rm=TRUE)^(1/2))
    train_mean[i] <- (mean(x[[as.character(stock_stats$Name[i])]], na.rm=TRUE))
    train_med[i] <- (median(x[[as.character(stock_stats$Name[i])]], na.rm=TRUE))
  }
  
  stock_stats$StandardDev <- std
  stock_stats$Mean <- train_mean
  stock_stats$Median <- train_med
  
  return(stock_stats)
}

stock_stats <- generateStats(stocks)
```

Now lets do some labeling of the movements and values. Right now these cuts are arbitrary, we should decice where and how we want to categorize
```{r}
rownames(stock_stats) <- stock_stats$Name

getLabel <- function(value, mean, standardDev, extreme, large, standard) {
  label <- ""
  if (is.na(value) || is.na(standardDev)) {
    label <- NULL
  } else if (value < mean + (-1 * extreme * standardDev)) {
    label <- "Down Extreme"
  } else if (value < mean + (-1 * large * standardDev)) {
    label <- "Down Large"
  } else if (value < mean + (-1 * standard * standardDev)) {
    label <- "Down"
  } else if (value < mean + (standard * standardDev)) {
    label <- "No Move"
  } else if (value < mean + (large * standardDev)) {
    label <- "Up"
  } else if (value < mean + (extreme * standardDev)) {
    label <- "Up Large"
  } else {
    label <- "Up Extreme"
  }
  
  return(label)
}

applyLabels <- function(data, stats){
  for (i in 1:(dim(data)[1] - 1)) {
    data$DailyMoveCat[i] <- getLabel(data$DailyMove[i], 0, stats["DailyMove","StandardDev"], 3, 1.5, 0.1)
    data$CloseDiffCat[i] <- getLabel(data$CloseDiff[i], 0, stats["CloseDiff","StandardDev"], 3, 1.5, 0.1)
    data$ONDiffCat[i] <- getLabel(data$ONDiff[i], 0, stats["ONDiff","StandardDev"], 3, 1.5, 0.1)
    data$SpreadCat[i] <- getLabel(data$Spread[i], stats["Spread","Mean"], stats["Spread","StandardDev"], 3, 1.5, 0.1)
  }
  
  return(data)
}

stocks <- applyLabels(stocks, stock_stats)
```


```{r}
factorize <- function(data) {
  labels <- c("Down Extreme", "Down Large", "Down", "No Move", "Up", "Up Large", "Up Extreme")
  data$DailyMoveCat <-factor(data$DailyMoveCat, levels=labels, ordered = TRUE)
  data$CloseDiffCat <-factor(data$CloseDiffCat, levels=labels, ordered = TRUE)
  data$ONDiffCat <-factor(data$ONDiffCat, levels=labels, ordered = TRUE)
  data$SpreadCat <-factor(data$SpreadCat, levels=labels, ordered = TRUE)
  
  return(data)
}

stocks <- factorize(stocks)

table(stocks$DailyMoveCat)
table(stocks$CloseDiffCat)
table(stocks$ONDiffCat)
table(stocks$SpreadCat)
```

Finally here are just some histograms to visualize the data

```{r}
pdf(paste(imagesBase,"SpeadHist.pdf", sep = ""))
hist(stocks$Spread, breaks=50)
dev.off()

pdf(paste(imagesBase,"DailyMoveHist.pdf", sep = ""))
hist(stocks$DailyMove, breaks=50)
dev.off()

pdf(paste(imagesBase,"CloseDiffHist.pdf", sep = ""))
hist(stocks$CloseDiff, breaks=50)
dev.off()

pdf(paste(imagesBase,"OverNightHist.pdf", sep = ""))
hist(stocks$ONDiff, breaks=50)
dev.off()
```

```{r}
stock_labels = select(stocks, "Date","DailyMoveCat","CloseDiffCat","ONDiffCat","SpreadCat")
write.csv(stock_labels, saveFile, row.names = FALSE)
```
